name: Conviso Security Gate

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  check-vulnerabilities:
    runs-on: ubuntu-latest

    env:
      CONVISO_API_KEY: ${{ secrets.CONVISO_API_KEY }}
      BLOCKED_CWES: '["CWE-94", "CWE-259"]'
      CONVISO_COMPANY_ID: 843
      REPO_SHORT_NAME: ${{ github.event.repository.name }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get Asset ID by Repository Name
        run: |
          echo "🔍 Buscando asset para o repositório $REPO_SHORT_NAME"

          QUERY=$(jq -n --arg filterName "$REPO_SHORT_NAME" '{
            query: "query($companyId:Int!, $filterName:String) { assets(companyId: 843, filters: {name: $filterName}, pagination: {page:1, perPage:1}) { collection { id name } } }",
            variables: {
              companyId: 843,
              filterName: $filterName
            }
          }')

          RESPONSE=$(curl -s -X POST https://app.convisoappsec.com/graphql \
            -H "Authorization: Bearer $CONVISO_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$QUERY")

          echo "📦 Resposta da API: $RESPONSE"

          ASSET_ID=$(echo "$RESPONSE" | jq -r '.data.assets.collection[0].id // empty')

          if [ -z "$ASSET_ID" ]; then
            echo "❌ Asset não encontrado para o repo $REPO_SHORT_NAME"
            exit 1
          fi

          echo "✅ Asset encontrado: ID=$ASSET_ID"
          echo "ASSET_ID=$ASSET_ID" >> $GITHUB_ENV

      - name: Validate vulnerabilities by CWE rules
        run: |
          echo "🔎 Validando vulnerabilidades do asset $ASSET_ID com CWEs bloqueados: $BLOCKED_CWES"

          QUERY=$(jq -n --argjson assetIds "[$ASSET_ID]" '{
            query: "query GetIssuesWithSeverityAndCwe($companyId:Int!, $assetIds:[Int!]) { issues(companyId: 843, pagination: {page:1, perPage:100}, filters: {assetIds: $assetIds}) { collection { id title severity category asset { id name } } } }",
            variables: { companyId: 843, assetIds: $assetIds }
          }')

          RESPONSE=$(curl -s -X POST https://app.convisoappsec.com/graphql \
            -H "Authorization: Bearer $CONVISO_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$QUERY")

          BLOCKED_ISSUES=$(echo "$RESPONSE" | jq -c --argjson blockedCwes "$BLOCKED_CWES" '
            .data.issues.collection | map(select(.category as $c | $blockedCwes | index($c)))')

          if [ "$(echo "$BLOCKED_ISSUES" | jq length)" -gt 0 ]; then
            echo "🚫 Ativo NÃO está conforme. Vulnerabilidades CWE bloqueadas encontradas:"
            echo "$BLOCKED_ISSUES" | jq
            exit 1
          else
            echo "✅ Ativo está conforme, sem CWEs bloqueados."
          fi
